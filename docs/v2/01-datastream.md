# æ•°æ®æµè®¾è®¡

## æ¦‚è§ˆ

æœ¬æ–‡æ¡£æè¿°ç³»ç»Ÿä¸­ 4 ä¸ªæ ¸å¿ƒæ•°æ®æµï¼š

1. **ç”¨æˆ·æ”¯ä»˜æµ** - ç”¨æˆ·å¦‚ä½•æ”¯ä»˜è½¬å½• Space æˆ– AI èŠå¤©
2. **Worker è½¬å½•ä»»åŠ¡æµ** - Worker å¦‚ä½•æ¥åˆ°ä»»åŠ¡å¹¶æ‰§è¡Œè½¬å½•
3. **Dashboard æ˜¾ç¤ºæµ** - Dashboard å¦‚ä½•æ˜¾ç¤ºæ‰€æœ‰ spaces
4. **AI èŠå¤©æµ** - ç”¨æˆ·å¦‚ä½•ä¸ Space è¿›è¡Œ AI é—®ç­”

---

## æ•°æ®æµ 1ï¼šç”¨æˆ·æ”¯ä»˜æµï¼ˆè½¬å½• Spaceï¼‰

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è®¿é—®   â”‚
â”‚  Dashboard   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‚¹å‡»"è½¬å½•æ–°Space"  â”‚
â”‚  è¾“å…¥ Space URL     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‚¹å‡»"è½¬å½•"æŒ‰é’®           â”‚
â”‚  è§¦å‘æ”¯ä»˜æµç¨‹             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Middleware (x402)             â”‚
â”‚  æ£€æµ‹åˆ°éœ€è¦æ”¯ä»˜çš„è·¯ç”±                   â”‚
â”‚  è¿”å› 402 Payment Required             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  x402-next å®¢æˆ·ç«¯                      â”‚
â”‚  1. è‡ªåŠ¨å¼¹å‡ºé’±åŒ…è¿æ¥ï¼ˆRainbowKitï¼‰      â”‚
â”‚  2. è¯·æ±‚ç”¨æˆ·ç­¾å EIP-3009             â”‚
â”‚  3. ç”Ÿæˆæ”¯ä»˜è¯æ˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡æ–°è¯·æ±‚ APIï¼ˆæºå¸¦æ”¯ä»˜è¯æ˜ï¼‰           â”‚
â”‚  POST /api/transcribe                  â”‚
â”‚  Headers: x-payment-proof              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Middleware éªŒè¯æ”¯ä»˜            â”‚
â”‚  1. éªŒè¯ EIP-3009 ç­¾å                 â”‚
â”‚  2. è°ƒç”¨ Facilitator æ‰§è¡Œé“¾ä¸Šè½¬è´¦      â”‚
â”‚  3. éªŒè¯äº¤æ˜“æˆåŠŸ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Route Handler                     â”‚
â”‚  POST /api/transcribe                  â”‚
â”‚                                        â”‚
â”‚  1. æå– Space ID                      â”‚
â”‚  2. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨                     â”‚
â”‚  3. åˆ›å»ºæ•°æ®åº“è®°å½•                     â”‚
â”‚     INSERT INTO spaces                 â”‚
â”‚     (space_id, space_url, status)      â”‚
â”‚     VALUES (?, ?, 'pending')           â”‚
â”‚  4. è®°å½•æ”¯ä»˜                           â”‚
â”‚     INSERT INTO transcription_requests â”‚
â”‚     (space_id, wallet, tx_hash)        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å›å“åº”                               â”‚
â”‚  {                                     â”‚
â”‚    success: true,                      â”‚
â”‚    spaceId: "xxx",                     â”‚
â”‚    status: "pending",                  â”‚
â”‚    message: "è½¬å½•ä»»åŠ¡å·²åˆ›å»º"            â”‚
â”‚  }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯é‡å®šå‘åˆ°è¿›åº¦é¡µé¢                   â”‚
â”‚  /spaces/[id]/processing               â”‚
â”‚  å¼€å§‹è½®è¯¢çŠ¶æ€                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç 

#### Next.js Middleware

```typescript
// middleware.ts
import { paymentMiddleware } from 'x402-next';

export const middleware = paymentMiddleware(
  process.env.PAY_TO_ADDRESS,
  {
    '/api/transcribe': {
      price: '$0.20',  // 0.2 USDC
      network: 'base',
      config: {
        description: 'Transcribe Twitter Space',
      },
    },
  },
  {
    url: process.env.FACILITATOR_URL,
  }
);

export const config = {
  matcher: ['/api/transcribe', '/api/chat'],
};
```

#### API Route

```typescript
// app/api/transcribe/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/lib/db';
import { spaces, transcriptionRequests } from '@/lib/db/schema';

export async function POST(request: NextRequest) {
  const body = await request.json();
  const { spaceUrl } = body;

  // æå– Space ID
  const spaceId = extractSpaceId(spaceUrl);

  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
  const existing = await db
    .select()
    .from(spaces)
    .where(eq(spaces.spaceId, spaceId))
    .limit(1);

  if (existing.length > 0) {
    return NextResponse.json({
      success: true,
      spaceId,
      status: existing[0].status,
      message: 'è¯¥ Space å·²åœ¨å¤„ç†ä¸­æˆ–å·²å®Œæˆ',
    });
  }

  // åˆ›å»ºè½¬å½•ä»»åŠ¡
  await db.insert(spaces).values({
    spaceId,
    spaceUrl,
    title: `Space ${spaceId}`,
    status: 'pending',
  });

  // è®°å½•æ”¯ä»˜ï¼ˆä» middleware ä¼ é€’çš„ä¿¡æ¯ï¼‰
  const paymentProof = request.headers.get('x-payment-proof');
  const walletAddress = request.headers.get('x-wallet-address');

  await db.insert(transcriptionRequests).values({
    spaceId,
    walletAddress,
    amountUsdc: '0.2',
    transactionHash: paymentProof,
  });

  return NextResponse.json({
    success: true,
    spaceId,
    status: 'pending',
    message: 'è½¬å½•ä»»åŠ¡å·²åˆ›å»º',
  });
}
```

---

## æ•°æ®æµ 2ï¼šWorker è½¬å½•ä»»åŠ¡æµ

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker å¯åŠ¨                   â”‚
â”‚  while (true) { ... }          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŸ¥è¯¢æ•°æ®åº“                     â”‚
â”‚  SELECT * FROM spaces           â”‚
â”‚  WHERE status = 'pending'       â”‚
â”‚  ORDER BY created_at            â”‚
â”‚  LIMIT 1                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€ æ— ä»»åŠ¡ â”€â”
       â”‚         â”‚
       â”‚         â–¼
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚  ç­‰å¾… 10 ç§’ â”‚
       â”‚    â”‚  continue   â”‚
       â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚          â”‚
       â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                          â”‚
       â”œâ”€ æœ‰ä»»åŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                          â”‚
       â–¼                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ›´æ–°çŠ¶æ€ä¸º processing          â”‚
â”‚  UPDATE spaces                  â”‚
â”‚  SET status = 'processing',     â”‚
â”‚      processing_started_at = NOWâ”‚
â”‚  WHERE id = ?                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 1: ä¸‹è½½éŸ³é¢‘              â”‚
â”‚  downloadSpace(spaceUrl)        â”‚
â”‚                                 â”‚
â”‚  1. æå– Space ID               â”‚
â”‚  2. è°ƒç”¨ Twitter GraphQL API    â”‚
â”‚  3. è·å– HLS æµ URL             â”‚
â”‚  4. ä½¿ç”¨ FFmpeg ä¸‹è½½éŸ³é¢‘        â”‚
â”‚  5. ä¿å­˜åˆ°                      â”‚
â”‚     data/spaces/{id}/audio.m4a  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 2: è½¬å½•éŸ³é¢‘              â”‚
â”‚  transcribeAudio(audioPath)     â”‚
â”‚                                 â”‚
â”‚  1. æ£€æŸ¥æ–‡ä»¶å¤§å°                â”‚
â”‚  2. å¦‚æœ > 25MB:                â”‚
â”‚     - åˆ‡åˆ†ä¸º 10 åˆ†é’Ÿå—          â”‚
â”‚     - å¹¶è¡Œè°ƒç”¨ Whisper API      â”‚
â”‚     - åˆå¹¶ç»“æœ                  â”‚
â”‚  3. å¦‚æœ <= 25MB:               â”‚
â”‚     - ç›´æ¥è°ƒç”¨ Whisper API      â”‚
â”‚  4. è¿”å›åŸå§‹è½¬å½•æ–‡æœ¬            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 3: æ ¼å¼åŒ–è½¬å½•            â”‚
â”‚  formatTranscript(rawText)      â”‚
â”‚                                 â”‚
â”‚  1. è°ƒç”¨ GPT-4o API             â”‚
â”‚  2. è¯†åˆ«è¯´è¯äºº                  â”‚
â”‚  3. æ ¼å¼åŒ–ä¸ºå¯¹è¯å½¢å¼            â”‚
â”‚  4. æ¸…ç†å¡«å……è¯                  â”‚
â”‚  5. è¿”å›ç»“æ„åŒ–æ•°æ®              â”‚
â”‚     { participants, text }      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿å­˜è½¬å½•æ–‡ä»¶                   â”‚
â”‚  saveTranscript(spaceId, data)  â”‚
â”‚                                 â”‚
â”‚  å†™å…¥æ–‡ä»¶:                      â”‚
â”‚  data/spaces/{id}/transcript.md â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ›´æ–°æ•°æ®åº“çŠ¶æ€                 â”‚
â”‚  UPDATE spaces                  â”‚
â”‚  SET status = 'completed',      â”‚
â”‚      completed_at = NOW,        â”‚
â”‚      transcript_file_path = ?,  â”‚
â”‚      participants = ?,          â”‚
â”‚      audio_duration = ?         â”‚
â”‚  WHERE id = ?                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®°å½•æ—¥å¿—                       â”‚
â”‚  console.log('âœ“ Completed')    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç­‰å¾… 5 ç§’                      â”‚
â”‚  ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç 

```typescript
// scripts/worker.ts
import { db } from '@/lib/db';
import { spaces } from '@/lib/db/schema';
import { formatSpaceFromUrl } from '@/lib/transcription';

export async function startWorker() {
  console.log('ğŸš€ Worker started');

  while (true) {
    try {
      // 1. æŸ¥æ‰¾å¾…å¤„ç†ä»»åŠ¡
      const jobs = await db
        .select()
        .from(spaces)
        .where(eq(spaces.status, 'pending'))
        .orderBy(spaces.createdAt)
        .limit(1);

      if (jobs.length === 0) {
        await sleep(10000);
        continue;
      }

      const job = jobs[0];
      console.log(`Processing: ${job.spaceId}`);

      // 2. æ›´æ–°çŠ¶æ€
      await db
        .update(spaces)
        .set({
          status: 'processing',
          processingStartedAt: new Date(),
        })
        .where(eq(spaces.id, job.id));

      // 3. è½¬å½•
      const result = await formatSpaceFromUrl(job.spaceUrl);

      // 4. ä¿å­˜æ–‡ä»¶
      const transcriptPath = `data/spaces/${job.spaceId}/transcript.md`;
      await saveTranscript(transcriptPath, result.formattedTranscript);

      // 5. æ›´æ–°ä¸ºå®Œæˆ
      await db
        .update(spaces)
        .set({
          status: 'completed',
          completedAt: new Date(),
          transcriptFilePath: transcriptPath,
          participants: JSON.stringify(result.participants),
          audioDurationSeconds: result.duration,
        })
        .where(eq(spaces.id, job.id));

      console.log(`âœ“ Completed: ${job.spaceId}`);
    } catch (error) {
      console.error('Worker error:', error);
      // æ ‡è®°ä¸ºå¤±è´¥
      if (job) {
        await db
          .update(spaces)
          .set({ status: 'failed' })
          .where(eq(spaces.id, job.id));
      }
    }

    await sleep(5000);
  }
}
```

---

## æ•°æ®æµ 3ï¼šDashboard æ˜¾ç¤ºæµ

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è®¿é—® Dashboard  â”‚
â”‚  GET /               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js é¡µé¢ç»„ä»¶åŠ è½½           â”‚
â”‚  app/page.tsx                   â”‚
â”‚                                 â”‚
â”‚  useEffect(() => {              â”‚
â”‚    loadSpaces();                â”‚
â”‚  }, []);                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°ƒç”¨ API                       â”‚
â”‚  GET /api/spaces                â”‚
â”‚  ?limit=50&offset=0             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Route Handler              â”‚
â”‚  app/api/spaces/route.ts        â”‚
â”‚                                 â”‚
â”‚  æŸ¥è¯¢æ•°æ®åº“:                    â”‚
â”‚  SELECT                         â”‚
â”‚    space_id,                    â”‚
â”‚    title,                       â”‚
â”‚    creator,                     â”‚
â”‚    participants,                â”‚
â”‚    audio_duration_seconds,      â”‚
â”‚    completed_at                 â”‚
â”‚  FROM spaces                    â”‚
â”‚  WHERE status = 'completed'     â”‚
â”‚  ORDER BY completed_at DESC     â”‚
â”‚  LIMIT 50                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å› JSON                      â”‚
â”‚  {                              â”‚
â”‚    spaces: [                    â”‚
â”‚      {                          â”‚
â”‚        spaceId: "xxx",          â”‚
â”‚        title: "xxx",            â”‚
â”‚        participants: [...],     â”‚
â”‚        duration: 3600,          â”‚
â”‚        completedAt: "..."       â”‚
â”‚      },                         â”‚
â”‚      ...                        â”‚
â”‚    ]                            â”‚
â”‚  }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯æ¸²æŸ“                       â”‚
â”‚  setSpaces(data.spaces)         â”‚
â”‚                                 â”‚
â”‚  æ˜¾ç¤ºä¸ºå¡ç‰‡ç½‘æ ¼:                â”‚
â”‚  - Space æ ‡é¢˜                   â”‚
â”‚  - åˆ›å»ºè€…                       â”‚
â”‚  - æ—¶é•¿                         â”‚
â”‚  - å‚ä¸è€…å¤´åƒ                   â”‚
â”‚  - å®Œæˆæ—¶é—´                     â”‚
â”‚  - ç‚¹å‡»è¿›å…¥è¯¦æƒ…                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç 

#### API Route

```typescript
// app/api/spaces/route.ts
import { NextResponse } from 'next/server';
import { db } from '@/lib/db';
import { spaces } from '@/lib/db/schema';
import { eq, desc } from 'drizzle-orm';

export async function GET() {
  const allSpaces = await db
    .select({
      spaceId: spaces.spaceId,
      title: spaces.title,
      creator: spaces.creator,
      participants: spaces.participants,
      duration: spaces.audioDurationSeconds,
      completedAt: spaces.completedAt,
    })
    .from(spaces)
    .where(eq(spaces.status, 'completed'))
    .orderBy(desc(spaces.completedAt))
    .limit(50);

  return NextResponse.json({ spaces: allSpaces });
}
```

#### å‰ç«¯ç»„ä»¶

```typescript
// app/page.tsx
'use client';

import { useState, useEffect } from 'react';

export default function Dashboard() {
  const [spaces, setSpaces] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadSpaces();
  }, []);

  async function loadSpaces() {
    try {
      const response = await fetch('/api/spaces');
      const data = await response.json();
      setSpaces(data.spaces);
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="max-w-7xl mx-auto p-6">
      <h1 className="text-4xl font-bold mb-8">
        Twitter Space è½¬å½•åº“
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {spaces.map((space) => (
          <SpaceCard key={space.spaceId} space={space} />
        ))}
      </div>
    </div>
  );
}
```

---

## æ•°æ®æµ 4ï¼šAI èŠå¤©æµ

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·åœ¨ Space è¯¦æƒ…é¡µ     â”‚
â”‚  è¾“å…¥é—®é¢˜                â”‚
â”‚  ç‚¹å‡»"æé—®"æŒ‰é’®          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§¦å‘æ”¯ä»˜æµç¨‹                   â”‚
â”‚  POST /api/chat                 â”‚
â”‚  {                              â”‚
â”‚    spaceId: "xxx",              â”‚
â”‚    question: "..."              â”‚
â”‚  }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Middleware (x402)      â”‚
â”‚  æ£€æµ‹åˆ°éœ€è¦æ”¯ä»˜                 â”‚
â”‚  è¿”å› 402 Payment Required      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  x402-next å®¢æˆ·ç«¯å¤„ç†æ”¯ä»˜       â”‚
â”‚  1. è¿æ¥é’±åŒ…                    â”‚
â”‚  2. ç”¨æˆ·ç­¾å EIP-3009           â”‚
â”‚  3. ç”Ÿæˆæ”¯ä»˜è¯æ˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡æ–°è¯·æ±‚ APIï¼ˆæºå¸¦æ”¯ä»˜è¯æ˜ï¼‰   â”‚
â”‚  POST /api/chat                 â”‚
â”‚  Headers: x-payment-proof       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Middleware éªŒè¯æ”¯ä»˜            â”‚
â”‚  éªŒè¯é€šè¿‡ï¼Œæ”¾è¡Œåˆ° Route Handler â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Route Handler              â”‚
â”‚  app/api/chat/route.ts          â”‚
â”‚                                 â”‚
â”‚  1. æŸ¥è¯¢ space                  â”‚
â”‚  2. æ£€æŸ¥çŠ¶æ€æ˜¯å¦ completed      â”‚
â”‚  3. è¯»å–è½¬å½•æ–‡ä»¶                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°ƒç”¨ OpenAI Agent SDK          â”‚
â”‚  const agent = new Agent({      â”‚
â”‚    model: 'gpt-4o'              â”‚
â”‚  });                            â”‚
â”‚                                 â”‚
â”‚  const response = agent.chat({  â”‚
â”‚    messages: [                  â”‚
â”‚      {                          â”‚
â”‚        role: 'system',          â”‚
â”‚        content: systemPrompt    â”‚
â”‚      },                         â”‚
â”‚      {                          â”‚
â”‚        role: 'user',            â”‚
â”‚        content: question        â”‚
â”‚      }                          â”‚
â”‚    ]                            â”‚
â”‚  });                            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®°å½•èŠå¤©å†å²                   â”‚
â”‚  INSERT INTO chat_payments      â”‚
â”‚  (space_id, wallet, question,   â”‚
â”‚   answer, amount_usdc, tx_hash) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¿”å› AI å›ç­”                   â”‚
â”‚  {                              â”‚
â”‚    success: true,               â”‚
â”‚    answer: "...",               â”‚
â”‚    spaceTitle: "..."            â”‚
â”‚  }                              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯æ˜¾ç¤ºå›ç­”                   â”‚
â”‚  æ¸²æŸ“ Markdown                  â”‚
â”‚  æ˜¾ç¤ºå¼•ç”¨æ¥æº                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®ä»£ç 

#### Middleware é…ç½®

```typescript
// middleware.ts
export const middleware = paymentMiddleware(
  process.env.PAY_TO_ADDRESS,
  {
    '/api/transcribe': {
      price: '$0.20',
      network: 'base',
    },
    '/api/chat': {
      price: '$0.50',  // AI èŠå¤©ä»·æ ¼
      network: 'base',
      config: {
        description: 'AI Chat with Space',
      },
    },
  },
  {
    url: process.env.FACILITATOR_URL,
  }
);
```

#### API Route

```typescript
// app/api/chat/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { Agent } from '@openai/agent-sdk';
import { db } from '@/lib/db';
import { spaces, chatPayments } from '@/lib/db/schema';
import { readFile } from 'fs/promises';

const agent = new Agent({
  model: 'gpt-4o',
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
  const body = await request.json();
  const { spaceId, question } = body;

  // 1. æŸ¥è¯¢ space
  const space = await db
    .select()
    .from(spaces)
    .where(eq(spaces.spaceId, spaceId))
    .limit(1);

  if (!space[0] || space[0].status !== 'completed') {
    return NextResponse.json(
      { error: 'Space not found or not ready' },
      { status: 404 }
    );
  }

  // 2. è¯»å–è½¬å½•å†…å®¹
  const transcript = await readFile(
    space[0].transcriptFilePath,
    'utf-8'
  );

  // 3. è°ƒç”¨ OpenAI Agent SDK
  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ª Twitter Space è½¬å½•åˆ†æåŠ©æ‰‹ã€‚
ç”¨æˆ·æä¾›äº†ä¸€ä¸ª Space çš„å®Œæ•´è½¬å½•å†…å®¹ï¼Œä½ éœ€è¦æ ¹æ®è½¬å½•å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚

Space æ ‡é¢˜: ${space[0].title}

è½¬å½•å†…å®¹:
${transcript}`;

  const response = await agent.chat({
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: question },
    ],
  });

  // 4. è®°å½•èŠå¤©å†å²
  const walletAddress = request.headers.get('x-wallet-address');
  const paymentProof = request.headers.get('x-payment-proof');

  await db.insert(chatPayments).values({
    spaceId: space[0].id,
    walletAddress,
    question,
    answer: response.content,
    amountUsdc: '0.5',
    transactionHash: paymentProof,
  });

  return NextResponse.json({
    success: true,
    answer: response.content,
    spaceTitle: space[0].title,
  });
}
```

---

## æ•°æ®æµæ€»ç»“

### æµç¨‹å¯¹æ¯”

| æ•°æ®æµ | è§¦å‘æ–¹å¼ | æ˜¯å¦éœ€è¦æ”¯ä»˜ | å¤„ç†æ—¶é—´ | ç”¨æˆ·å¯è§æ€§ |
|--------|---------|-------------|---------|----------|
| **ç”¨æˆ·æ”¯ä»˜æµ** | ç”¨æˆ·ä¸»åŠ¨ | âœ… æ˜¯ï¼ˆ0.2 USDCï¼‰ | < 10 ç§’ | ç«‹å³åé¦ˆ |
| **Worker è½¬å½•æµ** | è‡ªåŠ¨è½®è¯¢ | âŒ å¦ | 3-5 åˆ†é’Ÿ | åå°å¤„ç† |
| **Dashboard æ˜¾ç¤ºæµ** | é¡µé¢åŠ è½½ | âŒ å¦ | < 2 ç§’ | å®æ—¶åŠ è½½ |
| **AI èŠå¤©æµ** | ç”¨æˆ·ä¸»åŠ¨ | âœ… æ˜¯ï¼ˆ0.5 USDCï¼‰ | < 10 ç§’ | ç«‹å³åé¦ˆ |

### å…³é”®æŠ€æœ¯ç‚¹

1. **x402-next** - ç®€åŒ–æ”¯ä»˜æµç¨‹ï¼Œè‡ªåŠ¨å¤„ç† 402 å“åº”
2. **Next.js Middleware** - ç»Ÿä¸€æ”¯ä»˜éªŒè¯ï¼Œæ— éœ€æ¯ä¸ª API é‡å¤ä»£ç 
3. **PostgreSQL** - æ”¯æŒå¹¶å‘ï¼ŒWorker å’Œ API æ— é”ç«äº‰
4. **OpenAI Agent SDK** - å¼ºå¤§çš„ AI é—®ç­”èƒ½åŠ›
5. **æ–‡ä»¶ç³»ç»Ÿ + æ•°æ®åº“** - è½¬å½•å†…å®¹å­˜æ–‡ä»¶ï¼Œå…ƒæ•°æ®å­˜æ•°æ®åº“
